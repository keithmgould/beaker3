clear
close all
clc

A = [ ...
0	0	0
1	0	0
2	0	0
3	0	0
4	0	0
5	0	0
6	0	0
7	0	0
8	0	0
9	0	0
10	0	0
11	0	0
12	0	0
13	0	0
14	0	0
15	0	0
16	0	0
17	0	0
18	0	0
19	0	0
20	0	0
21	0	0
22	0	0
23	0	0
24	0	0
25	0	0
26	0	0
27	0	0
28	0	0
29	0	0
30	0	0
31	0	0
32	0	0
33	0	0
34	0	0
35	0	0
36	0	0
37	0	0
38	0	0
39	0	0
40	0	0
41	0	0
42	0	0
43	0	0
44	0	0
45	0	0
46	0	0
47	0	0
48	0	0
49	0	0
50	1	0
51	1	12
52	1	42
53	1	92
54	1	152
55	1	223
56	1	296
57	1	378
58	1	458
59	1	549
60	1	634
61	1	728
62	1	822
63	1	912
64	1	1009
65	1	1100
66	1	1198
67	1	1291
68	1	1390
69	1	1484
70	1	1583
71	1	1675
72	1	1774
73	1	1869
74	1	1969
75	1	2064
76	1	2164
77	1	2259
78	1	2360
79	1	2460
80	1	2554
81	1	2654
82	1	2748
83	1	2848
84	1	2943
85	1	3043
86	1	3138
87	1	3239
88	1	3333
89	1	3433
90	1	3528
91	1	3629
92	1	3723
93	1	3823
94	1	3923
95	1	4019
96	1	4118
97	1	4213
98	1	4314
99	1	4410
100	-1	4510
101	-1	4588
102	-1	4646
103	-1	4685
104	-1	4712
105	-1	4728
106	-1	4740
107	-1	4746
108	-1	4751
109	-1	4753
110	-1	4755
111	-1	4755
112	-1	4755
113	-1	4754
114	-1	4754
115	-1	4754
116	-1	4754
117	-1	4752
118	-1	4749
119	-1	4744
120	-1	4738
121	-1	4731
122	-1	4723
123	-1	4712
124	-1	4699
125	-1	4684
126	-1	4667
127	-1	4651
128	-1	4629
129	-1	4608
130	-1	4584
131	-1	4560
132	-1	4532
133	-1	4502
134	-1	4470
135	-1	4438
136	-1	4401
137	-1	4367
138	-1	4326
139	-1	4286
140	-1	4243
141	-1	4201
142	-1	4155
143	-1	4107
144	-1	4061
145	-1	4007
146	-1	3955
147	-1	3898
148	-1	3845
149	-1	3786
150	0	3729
151	0	3678
152	0	3645
153	0	3622
154	0	3608
155	0	3600
156	0	3596
157	0	3594
158	0	3592
159	0	3592
160	0	3592
161	0	3592
162	0	3592
163	0	3592
164	0	3592
165	0	3592
166	0	3592
167	0	3592
168	0	3592
169	0	3592
170	0	3592
171	0	3592
172	0	3592
173	0	3592
174	0	3592
175	0	3592
176	0	3592
177	0	3592
178	0	3592
179	0	3592
180	0	3592
181	0	3592
182	0	3592
183	0	3592
184	0	3592
185	0	3592
186	0	3592
187	0	3592
188	0	3592
189	0	3592
190	0	3592
191	0	3592
192	0	3592
193	0	3592
194	0	3592
195	0	3592
196	0	3592
197	0	3592
198	0	3592
199	0	3592];

Ts = 0.02;

t  = A(:,1)*Ts;
u  = A(:,2)*127;
y  = A(:,3)/600;
yd = diff(y)/Ts;

figure(1)
subplot(311); plot(t,u);
subplot(312); plot(t,y);
subplot(313); plot(t(1:end-1),yd);

N  = 99;
uu = u(1:N);
tt = t(1:N);
yy = yd(1:N);

id  = iddata(yy,uu,Ts);
sys = tfest(id,1,0);
fit = sys.Report.Fit.FitPercent;

[num,den] = tfdata(sys,'v');
Pident = tf(num,den);

figure(2); step(Pident);
figure(3); bode(Pident); grid on; 
figure(4); pzmap(Pident);
figure(5);
subplot(211);
plot(tt,yy,'k:',tt,lsim(sys,uu,tt),'r','linewidth',1.5);
legend('meas','ident','location','northwest'); ylabel('(rad/s)')
title(['2nd order fit: ',num2str(fit,'%2.2f'),'%']);
subplot(212); plot(tt,uu,'b','linewidth',1.5);
title('Input'); xlabel('time (s)'); ylabel('(serial value)')

